<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="lang">
  <head data-n-head="">
    <title data-n-head="true">Adding authentication to our Express blog with Passport.js | Nicholas Griffin</title><meta data-n-head="true" charset="utf-8"><meta data-n-head="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="true" data-hid="keywords" name="keywords" content="web developer,blogger,technology,founder,TechNutty"><meta data-n-head="true" data-hid="author" name="author" content="Nicholas Griffin"><meta data-n-head="true" data-hid="mobile-web-app-capable" name="mobile-web-app-capable" content="yes"><meta data-n-head="true" data-hid="apple-mobile-web-app-title" name="apple-mobile-web-app-title" content="nicholasgriffin"><meta data-n-head="true" data-hid="theme-color" name="theme-color" content="#fff"><meta data-n-head="true" data-hid="og:type" name="og:type" property="og:type" content="website"><meta data-n-head="true" data-hid="og:title" name="og:title" property="og:title" content="nicholasgriffin"><meta data-n-head="true" data-hid="og:site_name" name="og:site_name" property="og:site_name" content="nicholasgriffin"><meta data-n-head="true" data-hid="og:description" name="og:description" property="og:description" content="My personal website"><meta data-n-head="true" data-hid="description" name="description" content="Time to make things secure"><link data-n-head="true" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="true" rel="icon" type="apple-touch-icon" href="/icons/apple-touch-icon-57x57.png"><link data-n-head="true" rel="icon" type="apple-touch-icon" href="/icons/apple-touch-icon-60x60.png"><link data-n-head="true" rel="icon" type="apple-touch-icon" href="/icons/apple-touch-icon-72x72.png"><link data-n-head="true" rel="icon" type="apple-touch-icon" href="/icons/apple-touch-icon-76x76.png"><link data-n-head="true" rel="icon" type="apple-touch-icon" href="/icons/apple-touch-icon-114x114.png"><link data-n-head="true" rel="icon" type="apple-touch-icon" href="/icons/apple-touch-icon-120x120.png"><link data-n-head="true" rel="icon" type="apple-touch-icon" href="/icons/apple-touch-icon-144x144.png"><link data-n-head="true" rel="icon" type="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png"><link data-n-head="true" rel="icon" type="apple-touch-icon" href="/icons/apple-touch-icon-180x180.png"><link data-n-head="true" rel="icon" type="apple-touch-icon" href="/icons/favicon-32x32.png" sizes="32x32"><link data-n-head="true" rel="icon" type="apple-touch-icon" href="/icons/android-chrome-192x192.png" sizes="192x192"><link data-n-head="true" rel="icon" type="apple-touch-icon" href="/icons/favicon-96x96.png" sizes="96x96"><link data-n-head="true" rel="icon" type="apple-touch-icon" href="/icons/favicon-16x16.png" sizes="16x16"><link data-n-head="true" rel="mask-icon" type="apple-touch-icon" href="/icons/safari-pinned-tab.svg" color="#5bbad5"><link data-n-head="true" name="apple-mobile-web-app-title" content="Nicholas Griffin"><link data-n-head="true" name="application-name" content="Nicholas Griffin"><link data-n-head="true" name="theme-color" content="#5bbad5"><link data-n-head="true" rel="manifest" href="/manifest.json"><link data-n-head="true" rel="shortcut icon" href="/_nuxt/icons/icon_64.8AAfD9L2mjc.png"><link data-n-head="true" rel="apple-touch-icon" href="/_nuxt/icons/icon_512.8AAfD9L2mjc.png" sizes="512x512"><link rel="preload" href="/_nuxt/335238b4871730cf9f7d.js" as="script"><link rel="preload" href="/_nuxt/d26db56abffc2e10e685.js" as="script"><link rel="preload" href="/_nuxt/ed5ca3c40fa941f82244.js" as="script"><link rel="preload" href="/_nuxt/8c50d3902d6da8d5999e.js" as="script"><link rel="preload" href="/_nuxt/ad3882a62a81c04ccdbd.js" as="script"><style data-vue-ssr-id="17cfdfa9:0 aab9a468:0 9a8fa946:0">.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#fff;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}body,div#root{overflow-x:hidden}body,html{margin:0;padding:0;border:0;outline:0;vertical-align:baseline;background:0 0}.single-page .mid-box-background{padding-top:2rem;padding-bottom:2rem}.App{text-align:center}.App-header{position:fixed;top:0;left:0;width:100%;height:70vh;background-color:#222;padding:20vh 20px 20px;padding-left:0!important;color:#fff}.background-colours{opacity:.1}.background{position:absolute;top:0;right:0;bottom:0;left:0;background:#093054;background:-webkit-gradient(left top,right bottom,color-stop(0,#093054),color-stop(100%,#0b1042));background:linear-gradient(135deg,#093054,#0b1042)}.title-wrapper h1{font-size:3.1em!important;line-height:1.4;font-weight:700;color:#fff}.App-content{min-height:100vh;width:100vw;position:relative;background:#fff;z-index:9}.lazy{opacity:1;transition:opacity .3s}.lazy[data-src]{opacity:0}#OpeningContentWrapper img{max-height:80px;height:120px;margin-bottom:20px;margin-top:20px;width:auto}#BlogPostOpenerWrapper{display:inline-block;padding-top:40px;padding-bottom:40px;margin-top:20px;width:100%;color:#fff}#OpeningContentSocial a{text-decoration:none}#default-typed-strings,#second-typed-strings-delay,#third-typed-strings-delay,#typed-strings,#typed-strings-delay,.scroll-down{display:none}#OpeningContentWrapper p,#welcometomysite,.homepage-subtitle{display:inline-block}.homepage-subtitle #typed,.typed-cursor{font-size:1.5em!important}.typed-cursor{margin-left:10px}@media only screen and (min-width:992px){#OpeningContentWrapper{padding-top:0;padding-right:120px}#welcometomysite{margin-left:.25em}#MusicOpeningWrapper,div#OpeningContentWrapperWrap{padding-left:0!important;padding-right:0!important}}#welcometomysite{font-size:2.5em}.post-img{width:100%;height:auto;max-height:200px}.homepage-subtitle{width:calc(100% - 20px);overflow:hidden;text-overflow:ellipsis;margin-left:10px;margin-right:10px}#BlogandMoreAboutSeconndWrapper .card{overflow:hidden}#BlogandMoreAboutSeconndWrapper .card .image{margin-left:-1rem;margin-right:-1rem;margin-top:-1rem}.post-button.ui.bottom.button{margin-left:-1em;margin-top:-.75em;margin-bottom:-1em;border-radius:0;padding-bottom:1em;background:#19034e;color:#fff;width:calc(100% - 1em)}#TwitterLinkWrap,.social-icon{margin-left:10px;margin-right:10px;display:inline-block}.social-icon{max-width:40px}#cookie-law{position:fixed;bottom:10px;right:10px;width:100%;max-width:320px;background:#f6f6f6;border:1px solid #333;z-index:999;padding:5px}#blogLoadMoreButton{margin-top:20px;background:#ddd;color:#000}div#customSpotifyRight{height:300px}div#customSpotifyRightElementSongWrapper{height:100%;position:relative}div#customSpotifyRightElementSongContainer{height:100%;background-size:cover}div#customSpotifyRightElementSongOverlay{position:absolute;top:0;left:0;background:0 0;width:100%;height:100%;color:#fff}div#nowPlayingOverlay{position:absolute;right:0;top:0;background:#0b0444;padding:10px}#customSpotifyLeft,#customSpotifyRight,.leftSideSong div,a.trackLinkFloat{padding:0!important}div#customSpotifyRightElementSongOverlayContent{margin-top:100px}.trackLinkPlay svg{max-width:50px;fill:#fff;margin-top:10px}.trackLinkPlay svg path{fill:#fff}div#customSpotifyRightElementSongOverlayContent span,div#spotifyOpenerWrapper{display:inline-block;width:100%}div#spotifyOpenerWrapper{margin-top:50px;border-top:1px solid #ddd;border-bottom:1px solid}.leftSideSong{background:#000;color:#fff;position:relative}a.trackLinkFloat{position:absolute;top:0;left:0;width:100%;height:100%;margin:0!important;z-index:999}div#customSpotifyLeftElementSongWrapper{margin-top:15px;background:#000}.leftSideSong,div#spotify-widget{margin-left:0!important;margin-right:0!important}#spotify-widget{margin-top:20px!important}.leftSideSong.ui.grid{border-bottom:1px solid;padding-bottom:5px;padding-top:5px}.leftSideSong h3{margin-top:0;margin-bottom:0;font-size:1em}.leftSideSong span{margin-right:5px;font-size:.8em}div#customSpotifyLeft{max-height:150px;overflow-y:scroll;overflow-x:hidden}div#mainOpeningContentWrap{margin:10vh 0 0;display:flex}div#OpeningContentWrapper{text-align:left}@media only screen and (min-width:992px){#OpeningContentWrapper p img{max-height:2.5em;height:auto;margin-bottom:0;margin-top:0;width:auto}}@media only screen and (max-width:992px){#OpeningContentWrapper p img{max-height:5em;height:auto;margin-bottom:0;margin-top:0;width:auto}h2#welcometomysite{width:100%}}span#MusicOpeningWrapperTitle{display:inline-block;width:100%;margin-top:20px}div#spotify-widget{height:450px}.social-icon-wrap{font-size:2.4em;color:#000}#TwitterLinkWrap{color:#1da1f2}a#LinkedinLinkWrap{color:#0077b5}.coloured-container{background:#19034e;padding-bottom:250px;margin-top:100px}.coloured-float-container{margin-top:-250px;margin-bottom:100px}#ExtraContentWrapper{margin-top:150px;margin-bottom:150px}#SkillsContentContainer{margin-top:50px}.column.icon-grid-item{padding:0!important;text-align:center}.icon-grid-item img{max-width:50px!important}.icon-grid-item span{width:100%;display:inline-block;margin-top:10px}#SkillsContentContainer h3{margin-bottom:50px;margin-top:50px;display:inline-block;width:100%}.cookies.js-cookie-message{position:fixed;bottom:20px;right:0;max-width:320px;width:100%;z-index:9999;background:#fff;border-radius:4px;padding:1rem;border:1px solid #ddd;box-shadow:0 0 10px 0 rgba(0,0,0,.1)}.cookies__box button{width:100%;padding:.5rem;background:0;border-color:#171f32;color:#171f32;font-weight:600;border-radius:4px}body{margin:0;padding:0;font-family:sans-serif}header{background:#000;width:calc(100% - 2rem);padding:1rem}.text-normal{text-align:left;text-align:initial}header .site-title-header{display:inline-block;width:auto;font-size:1.5rem;color:#a3a7ae;font-weight:600}header .site-title-header a{text-decoration:none;color:#a3a7ae}header .site-links-header{display:inline-block;float:right}header .site-links-header a{color:#485569;text-transform:uppercase;text-decoration:none;font-size:1rem;padding:.25rem;display:inline-block}header a:hover{color:#fff!important}.ui.container{display:block;max-width:100%!important}@media only screen and (max-width:767px){.ui.container,.ui.grid.container,.ui.relaxed.grid.container,.ui.very.relaxed.grid.container{width:auto!important}.ui.container{margin-left:1em!important;margin-right:1em!important}}@media only screen and (min-width:768px) and (max-width:991px){.ui.container{width:723px;margin-left:auto!important;margin-right:auto!important}.ui.grid.container{width:calc(723px + 2rem)!important}.ui.relaxed.grid.container{width:calc(723px + 3rem)!important}.ui.very.relaxed.grid.container{width:calc(723px + 5rem)!important}}@media only screen and (min-width:992px) and (max-width:1199px){.ui.container{width:933px;margin-left:auto!important;margin-right:auto!important}.ui.grid.container{width:calc(933px + 2rem)!important}.ui.relaxed.grid.container{width:calc(933px + 3rem)!important}.ui.very.relaxed.grid.container{width:calc(933px + 5rem)!important}}@media only screen and (min-width:1200px){.ui.container{width:1127px;margin-left:auto!important;margin-right:auto!important}.ui.grid.container{width:calc(1127px + 2rem)!important}.ui.relaxed.grid.container{width:calc(1127px + 3rem)!important}.ui.very.relaxed.grid.container{width:calc(1127px + 5rem)!important}}#BlogContentContainer .card .image{max-height:220px;overflow:hidden}.repo-language-color{border-radius:50%;display:inline-block;height:12px;position:relative;top:1px;width:12px;background-color:#19034e}#githubReposContainer{margin:0;padding-top:1rem}.PHP .repo-language-color{background-color:#777bb4}.HTML .repo-language-color{background-color:#e34f25}.CSS .repo-language-color{background-color:#1372b6}.JavaScript .repo-language-color{background-color:#f7df1c}.repo-language-color{margin-right:5px!important}.card .content a.header{text-decoration:none;margin-bottom:5px}pre{background:#272727;color:#fff;padding:20px;white-space:pre-wrap;font-size:16px;font-family:Menlo,Monaco,Courier New,Courier,monospace;overflow:auto}.post-content-sidebar{max-width:320px}.App-content{top:0!important;margin-top:90vh}.single-page .App-content{top:0!important;margin-top:0!important}.social-icon-wrap svg{width:32px;height:auto}#TwitterLinkWrap svg,#TwitterLinkWrap svg path{fill:#1da1f2!important}#LinkedinLinkWrap svg,#LinkedinLinkWrap svg path{fill:#0077b5}.social-icon-wrap:hover svg{opacity:.6}@media only screen and (max-width:768px){.App-header.full-height-header{height:100%;padding-top:20px}}#MusicOpeningWrapperTitle svg{width:14px;display:inline-block;-webkit-transform:rotate(180deg);transform:rotate(180deg)}img.lazy.loaded{opacity:1!important}.alert.alert-danger{color:#d22d2d}.alert{width:100%;margin-bottom:20px;text-align:left}.button-block{display:block;width:100%}.button{border:0;outline:0;border-radius:0;padding:15px 0;font-size:22px;font-weight:600;text-transform:uppercase;letter-spacing:.1em;background:0 0;color:#fff;transition:all .5s ease;-webkit-appearance:none}.header-single-image-full img{width:100%;height:auto;top:50%;transition:translateY(-50%);position:relative}.post-header-titles{max-width:780px;margin:-70px auto auto;background:#fff;z-index:99;position:relative;padding:1rem}.header-single-image-full{max-height:500px;overflow:hidden;width:100%;height:auto;vertical-align:middle;display:block}.single-page .App-header{height:auto!important;padding-top:0!important;position:relative}.single-page .App-content{top:0!important;padding:1rem;text-align:left;min-height:150px;width:calc(100% - 2rem)}img.post-image{width:100%;height:auto}.post-content-wrap{max-width:780px;width:calc(100% - 2rem);margin:auto;padding:1rem}.post-buttons-wrapper .button{background:#000;font-size:.7rem;opacity:1;border-radius:4px;padding:1rem;cursor:pointer}.post-buttons-wrapper{margin-top:.5rem}</style>
  </head>
  <body data-n-head="">
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><script type="text/javascript" async src="https://www.google-analytics.com/analytics.js"></script> <script async src="https://www.googletagmanager.com/gtm.js?id=GTM-NK46QBJ"></script> <script>
  (function(w, d, s, l, i) {
    w[l] = w[l] || [];
    w[l].push({
      &quot;gtm.start&quot;: new Date().getTime(),
      event: &quot;gtm.js&quot;
    });
    var f = d.getElementsByTagName(s)[0],
      j = d.createElement(s),
      dl = l != &quot;dataLayer&quot; ? &quot;&amp;l=&quot; + l : &quot;&quot;;
    j.async = true;
    j.src = &quot;https://www.googletagmanager.com/gtm.js?id=&quot; + i + dl;
    f.parentNode.insertBefore(j, f);
  })(window, document, &quot;script&quot;, &quot;dataLayer&quot;, &quot;GTM-NK46QBJ&quot;);
    </script> <header><div class="ui container text-normal"><span class="site-title-header"><a href="https://nicholasgriffin.dev">
            Nicholas Griffin
        </a></span> <div class="site-links-header"><a href="https://nicholasgriffin.dev">
                Home
            </a></div></div></header> <div><div class="single-page"><div class="header-single-image-full"><img src="https://nicholasgriffin.dev/uploads/bp/2019/March/users_js.jpg" alt="Adding authentication to our Express blog with Passport.js" loading="lazy"></div> <div class="App-content"><div class="ui container"><div class="post-header"><div class="post-header-titles"><h1 id="single-title" class="animated bounceInDown">Adding authentication to our Express blog with Passport.js</h1> <h2><div class="post-buttons-wrapper"></div></h2></div></div> <div class="post-content-wrap"><p>In the last blog post we talked about <a href="../../../../../../../../post-single?postID=5c7be6e2a1e5fbe51cd94950">adding a blog to our personal site via Node, Express and Mongo</a>. In this blog post, we will be expanding upon that by adding authentication to our new Express APIs via something called Passport.js.</p>
<p>We will be going through the backend side of the code only during this post, creating a set of APIs for creating users, generating tokens for users, logging users in and requiring authentication for our APIs.</p>
<p>Let’s get started.</p>
<h2>Setting up our app</h2>
<p>For this post, I am going to expect that you have already set up a node environment, and have Mongo set up and ready to go. If you still need to do that, then it might be best to find a tutorial on how to do that before you follow this.</p>
<p>To start, you’ll need to make sure that you have the following packages installed and included within your main application file:</p>
<pre>const express = require('express');
const path = require('path');
const bodyParser = require('body-parser');
const session = require('express-session');
const cors = require('cors');
const mongoose = require('mongoose');
</pre>
<p>Now you will need to configure Mongose to use global promises and setup Express to use your modules and set up your sessions.</p>
<pre style="color:#000;background:#fff"><span style="color:#696969">//Configure mongoose's promise to global promise</span>
mongoose<span style="color:#808030">.</span>promise <span style="color:#808030">=</span> <span style="color:#797997">global</span><span style="color:#808030">.</span>Promise<span style="color:purple">;</span>

<span style="color:#696969">//Initiate our app</span>
<span style="color:maroon;font-weight:700">const</span> app <span style="color:#808030">=</span> express<span style="color:#808030">(</span><span style="color:#808030">)</span><span style="color:purple">;</span>

<span style="color:#696969">//Configure our app</span>
app<span style="color:#808030">.</span>use<span style="color:#808030">(</span>cors<span style="color:#808030">(</span><span style="color:#808030">)</span><span style="color:#808030">)</span><span style="color:purple">;</span>
app<span style="color:#808030">.</span>use<span style="color:#808030">(</span>require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">morgan</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">dev</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:#808030">)</span><span style="color:purple">;</span>
app<span style="color:#808030">.</span>use<span style="color:#808030">(</span>bodyParser<span style="color:#808030">.</span>urlencoded<span style="color:#808030">(</span><span style="color:purple">{</span> extended<span style="color:purple">:</span> <span style="color:#0f4d75">false</span> <span style="color:purple">}</span><span style="color:#808030">)</span><span style="color:#808030">)</span><span style="color:purple">;</span>
app<span style="color:#808030">.</span>use<span style="color:#808030">(</span>bodyParser<span style="color:#808030">.</span>json<span style="color:#808030">(</span><span style="color:#808030">)</span><span style="color:#808030">)</span><span style="color:purple">;</span>
app<span style="color:#808030">.</span>use<span style="color:#808030">(</span>express<span style="color:#808030">.</span><span style="color:maroon;font-weight:700">static</span><span style="color:#808030">(</span>path<span style="color:#808030">.</span><span style="color:maroon;font-weight:700">join</span><span style="color:#808030">(</span>__dirname<span style="color:#808030">,</span> <span style="color:maroon">'</span><span style="color:#0000e6">public</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:#808030">)</span><span style="color:#808030">)</span><span style="color:purple">;</span>
app<span style="color:#808030">.</span>use<span style="color:#808030">(</span>session<span style="color:#808030">(</span><span style="color:purple">{</span> secret<span style="color:purple">:</span> <span style="color:maroon">'</span><span style="color:#0000e6">my-super-secret-key</span><span style="color:maroon">'</span><span style="color:#808030">,</span> cookie<span style="color:purple">:</span> <span style="color:purple">{</span> maxAge<span style="color:purple">:</span> <span style="color:#008c00">60000</span> <span style="color:purple">}</span><span style="color:#808030">,</span> resave<span style="color:purple">:</span> <span style="color:#0f4d75">false</span><span style="color:#808030">,</span> saveUninitialized<span style="color:purple">:</span> <span style="color:#0f4d75">false</span> <span style="color:purple">}</span><span style="color:#808030">)</span><span style="color:#808030">)</span><span style="color:purple">;</span>
</pre>
<p>Make sure that you change your key to something really secret.</p>
<h2>Storing user data</h2>
<p>Now that you have set up and configured your app, you will need to create your model for the Users database that you will need for the next steps.</p>
<p>To do this, you will need to create a new folder called “models” and then create a file within that folder called “Users.js”.</p>
<p>We will be using this folder to define the schema for our users, hashing user passwords, generating a salt and creating the JWT that we will need latter. This file should look something like this:</p>
<pre style="color:#000;background:#fff"><span style="color:maroon;font-weight:700">const</span> mongoose <span style="color:#808030">=</span> require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">mongoose</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:maroon;font-weight:700">const</span> crypto <span style="color:#808030">=</span> require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">crypto</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:maroon;font-weight:700">const</span> jwt <span style="color:#808030">=</span> require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">jsonwebtoken</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>

<span style="color:maroon;font-weight:700">const</span> <span style="color:purple">{</span> Schema <span style="color:purple">}</span> <span style="color:#808030">=</span> mongoose<span style="color:purple">;</span>

<span style="color:maroon;font-weight:700">const</span> UsersSchema <span style="color:#808030">=</span> <span style="color:maroon;font-weight:700">new</span> Schema<span style="color:#808030">(</span><span style="color:purple">{</span>
  email<span style="color:purple">:</span> <span style="color:#797997">String</span><span style="color:#808030">,</span>
  hash<span style="color:purple">:</span> <span style="color:#797997">String</span><span style="color:#808030">,</span>
  salt<span style="color:purple">:</span> <span style="color:#797997">String</span><span style="color:#808030">,</span>
<span style="color:purple">}</span><span style="color:#808030">)</span><span style="color:purple">;</span>

UsersSchema<span style="color:#808030">.</span>methods<span style="color:#808030">.</span>setPassword <span style="color:#808030">=</span> <span style="color:maroon;font-weight:700">function</span><span style="color:#808030">(</span>password<span style="color:#808030">)</span> <span style="color:purple">{</span>
  <span style="color:maroon;font-weight:700">this</span><span style="color:#808030">.</span>salt <span style="color:#808030">=</span> crypto<span style="color:#808030">.</span>randomBytes<span style="color:#808030">(</span><span style="color:#008c00">16</span><span style="color:#808030">)</span><span style="color:#808030">.</span><span style="color:maroon;font-weight:700">toString</span><span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">hex</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>
  <span style="color:maroon;font-weight:700">this</span><span style="color:#808030">.</span>hash <span style="color:#808030">=</span> crypto<span style="color:#808030">.</span>pbkdf2Sync<span style="color:#808030">(</span>password<span style="color:#808030">,</span> <span style="color:maroon;font-weight:700">this</span><span style="color:#808030">.</span>salt<span style="color:#808030">,</span> <span style="color:#008c00">10000</span><span style="color:#808030">,</span> <span style="color:#008c00">512</span><span style="color:#808030">,</span> <span style="color:maroon">'</span><span style="color:#0000e6">sha512</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:#808030">.</span><span style="color:maroon;font-weight:700">toString</span><span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">hex</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:purple">}</span><span style="color:purple">;</span>

UsersSchema<span style="color:#808030">.</span>methods<span style="color:#808030">.</span>validatePassword <span style="color:#808030">=</span> <span style="color:maroon;font-weight:700">function</span><span style="color:#808030">(</span>password<span style="color:#808030">)</span> <span style="color:purple">{</span>
  <span style="color:maroon;font-weight:700">const</span> hash <span style="color:#808030">=</span> crypto<span style="color:#808030">.</span>pbkdf2Sync<span style="color:#808030">(</span>password<span style="color:#808030">,</span> <span style="color:maroon;font-weight:700">this</span><span style="color:#808030">.</span>salt<span style="color:#808030">,</span> <span style="color:#008c00">10000</span><span style="color:#808030">,</span> <span style="color:#008c00">512</span><span style="color:#808030">,</span> <span style="color:maroon">'</span><span style="color:#0000e6">sha512</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:#808030">.</span><span style="color:maroon;font-weight:700">toString</span><span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">hex</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>
  <span style="color:maroon;font-weight:700">return</span> <span style="color:maroon;font-weight:700">this</span><span style="color:#808030">.</span>hash <span style="color:#808030">===</span> hash<span style="color:purple">;</span>
<span style="color:purple">}</span><span style="color:purple">;</span>

UsersSchema<span style="color:#808030">.</span>methods<span style="color:#808030">.</span>generateJWT <span style="color:#808030">=</span> <span style="color:maroon;font-weight:700">function</span><span style="color:#808030">(</span><span style="color:#808030">)</span> <span style="color:purple">{</span>
  <span style="color:maroon;font-weight:700">const</span> today <span style="color:#808030">=</span> <span style="color:maroon;font-weight:700">new</span> <span style="color:#797997">Date</span><span style="color:#808030">(</span><span style="color:#808030">)</span><span style="color:purple">;</span>
  <span style="color:maroon;font-weight:700">const</span> expirationDate <span style="color:#808030">=</span> <span style="color:maroon;font-weight:700">new</span> <span style="color:#797997">Date</span><span style="color:#808030">(</span>today<span style="color:#808030">)</span><span style="color:purple">;</span>
  expirationDate<span style="color:#808030">.</span><span style="color:maroon;font-weight:700">setDate</span><span style="color:#808030">(</span>today<span style="color:#808030">.</span><span style="color:maroon;font-weight:700">getDate</span><span style="color:#808030">(</span><span style="color:#808030">)</span> <span style="color:#808030">+</span> <span style="color:#008c00">60</span><span style="color:#808030">)</span><span style="color:purple">;</span>

  <span style="color:maroon;font-weight:700">return</span> jwt<span style="color:#808030">.</span><span style="color:maroon;font-weight:700">sign</span><span style="color:#808030">(</span><span style="color:purple">{</span>
    email<span style="color:purple">:</span> <span style="color:maroon;font-weight:700">this</span><span style="color:#808030">.</span>email<span style="color:#808030">,</span>
    id<span style="color:purple">:</span> <span style="color:maroon;font-weight:700">this</span><span style="color:#808030">.</span>_id<span style="color:#808030">,</span>
    <span style="color:maroon;font-weight:700">exp</span><span style="color:purple">:</span> <span style="color:maroon;font-weight:700">parseInt</span><span style="color:#808030">(</span>expirationDate<span style="color:#808030">.</span><span style="color:maroon;font-weight:700">getTime</span><span style="color:#808030">(</span><span style="color:#808030">)</span> <span style="color:#808030">/</span> <span style="color:#008c00">1000</span><span style="color:#808030">,</span> <span style="color:#008c00">10</span><span style="color:#808030">)</span><span style="color:#808030">,</span>
  <span style="color:purple">}</span><span style="color:#808030">,</span> <span style="color:maroon">'</span><span style="color:#0000e6">secret</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:purple">}</span>

UsersSchema<span style="color:#808030">.</span>methods<span style="color:#808030">.</span>toAuthJSON <span style="color:#808030">=</span> <span style="color:maroon;font-weight:700">function</span><span style="color:#808030">(</span><span style="color:#808030">)</span> <span style="color:purple">{</span>
  <span style="color:maroon;font-weight:700">return</span> <span style="color:purple">{</span>
    _id<span style="color:purple">:</span> <span style="color:maroon;font-weight:700">this</span><span style="color:#808030">.</span>_id<span style="color:#808030">,</span>
    email<span style="color:purple">:</span> <span style="color:maroon;font-weight:700">this</span><span style="color:#808030">.</span>email<span style="color:#808030">,</span>
    token<span style="color:purple">:</span> <span style="color:maroon;font-weight:700">this</span><span style="color:#808030">.</span>generateJWT<span style="color:#808030">(</span><span style="color:#808030">)</span><span style="color:#808030">,</span>
  <span style="color:purple">}</span><span style="color:purple">;</span>
<span style="color:purple">}</span><span style="color:purple">;</span>

mongoose<span style="color:#808030">.</span>model<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">Users</span><span style="color:maroon">'</span><span style="color:#808030">,</span> UsersSchema<span style="color:#808030">)</span><span style="color:purple">;</span>
</pre>
<p>To use this model, you will need to add the following to your application file under the line where you are settiing up Mongo.</p>
<pre>require('./models/Users');</pre>
<h2>Setting up our Passport.js config</h2>
<p>Now that we have set up our users model, we are ready to get started with our configuration for Passport.js.</p>
<p>To do this and keep it tidy we will need to create a new folder called “config”, which we will be using for the storage of our configuration files for this part and for future requirements.</p>
<p>Within this folder, we need to create a new file named “passport.js”.</p>
<pre style="color:#000;background:#fff"><span style="color:maroon;font-weight:700">const</span> mongoose <span style="color:#808030">=</span> require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">mongoose</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:maroon;font-weight:700">const</span> passport <span style="color:#808030">=</span> require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">passport</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:maroon;font-weight:700">const</span> LocalStrategy <span style="color:#808030">=</span> require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">passport-local</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>

<span style="color:maroon;font-weight:700">const</span> Users <span style="color:#808030">=</span> mongoose<span style="color:#808030">.</span>model<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">Users</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>

passport<span style="color:#808030">.</span>use<span style="color:#808030">(</span><span style="color:maroon;font-weight:700">new</span> LocalStrategy<span style="color:#808030">(</span><span style="color:purple">{</span>
  usernameField<span style="color:purple">:</span> <span style="color:maroon">'</span><span style="color:#0000e6">user[email]</span><span style="color:maroon">'</span><span style="color:#808030">,</span>
  passwordField<span style="color:purple">:</span> <span style="color:maroon">'</span><span style="color:#0000e6">user[password]</span><span style="color:maroon">'</span><span style="color:#808030">,</span>
<span style="color:purple">}</span><span style="color:#808030">,</span> <span style="color:#808030">(</span>email<span style="color:#808030">,</span> password<span style="color:#808030">,</span> done<span style="color:#808030">)</span> <span style="color:#808030">=</span><span style="color:#808030">></span> <span style="color:purple">{</span>
  Users<span style="color:#808030">.</span>findOne<span style="color:#808030">(</span><span style="color:purple">{</span> email <span style="color:purple">}</span><span style="color:#808030">)</span>
    <span style="color:#808030">.</span>then<span style="color:#808030">(</span><span style="color:#808030">(</span>user<span style="color:#808030">)</span> <span style="color:#808030">=</span><span style="color:#808030">></span> <span style="color:purple">{</span>
      <span style="color:maroon;font-weight:700">if</span><span style="color:#808030">(</span><span style="color:#808030">!</span>user <span style="color:#808030">||</span> <span style="color:#808030">!</span>user<span style="color:#808030">.</span>validatePassword<span style="color:#808030">(</span>password<span style="color:#808030">)</span><span style="color:#808030">)</span> <span style="color:purple">{</span>
        <span style="color:maroon;font-weight:700">return</span> done<span style="color:#808030">(</span><span style="color:#0f4d75">null</span><span style="color:#808030">,</span> <span style="color:#0f4d75">false</span><span style="color:#808030">,</span> <span style="color:purple">{</span> errors<span style="color:purple">:</span> <span style="color:purple">{</span> <span style="color:maroon">'</span><span style="color:#0000e6">email or password</span><span style="color:maroon">'</span><span style="color:purple">:</span> <span style="color:maroon">'</span><span style="color:#0000e6">is invalid</span><span style="color:maroon">'</span> <span style="color:purple">}</span> <span style="color:purple">}</span><span style="color:#808030">)</span><span style="color:purple">;</span>
      <span style="color:purple">}</span>

      <span style="color:maroon;font-weight:700">return</span> done<span style="color:#808030">(</span><span style="color:#0f4d75">null</span><span style="color:#808030">,</span> user<span style="color:#808030">)</span><span style="color:purple">;</span>
    <span style="color:purple">}</span><span style="color:#808030">)</span><span style="color:#808030">.</span><span style="color:maroon;font-weight:700">catch</span><span style="color:#808030">(</span>done<span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:purple">}</span><span style="color:#808030">)</span><span style="color:#808030">)</span><span style="color:purple">;</span>
</pre>
<p>This will basically use our password validation function from users to direct the user to the correct output.</p>
<p>To link this all together, you will need to add the following line after your model set up:</p>
<pre style="color:#000;background:#fff">require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">./config/passport</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>
</pre>
<h2>Setting up our authentication route</h2>
<p>The final step is to set up a route that can be used for authentication.</p>
<p>To do this, we will create a new folder named “routes” and then within that, we will create a file named “auth.js”. This will contain a function for getting a token from the user’s request headers.</p>
<p>It does this by looking for a header named authorization and then splitting everything in the value after the word ‘Token’, the part that is returned should be our JWT.</p>
<p>If a JWT cannnot be found it will return null, which we can use to display an error through the API later.</p>
<pre style="color:#000;background:#fff"><span style="color:maroon;font-weight:700">const</span> jwt <span style="color:#808030">=</span> require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">express-jwt</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>

<span style="color:maroon;font-weight:700">const</span> getJWT <span style="color:#808030">=</span> <span style="color:#808030">(</span>req<span style="color:#808030">)</span> <span style="color:#808030">=</span><span style="color:#808030">></span> <span style="color:purple">{</span>
  <span style="color:maroon;font-weight:700">const</span> <span style="color:purple">{</span> headers<span style="color:purple">:</span> <span style="color:purple">{</span> authorization <span style="color:purple">}</span> <span style="color:purple">}</span> <span style="color:#808030">=</span> req<span style="color:purple">;</span>

  <span style="color:maroon;font-weight:700">if</span><span style="color:#808030">(</span>authorization <span style="color:#808030">&&</span> authorization<span style="color:#808030">.</span><span style="color:maroon;font-weight:700">split</span><span style="color:#808030">(</span><span style="color:maroon">'</span> <span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:#808030">[</span><span style="color:#008c00">0</span><span style="color:#808030">]</span> <span style="color:#808030">===</span> <span style="color:maroon">'</span><span style="color:#0000e6">Token</span><span style="color:maroon">'</span><span style="color:#808030">)</span> <span style="color:purple">{</span>
    <span style="color:maroon;font-weight:700">return</span> authorization<span style="color:#808030">.</span><span style="color:maroon;font-weight:700">split</span><span style="color:#808030">(</span><span style="color:maroon">'</span> <span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:#808030">[</span><span style="color:#008c00">1</span><span style="color:#808030">]</span><span style="color:purple">;</span>
  <span style="color:purple">}</span>
  <span style="color:maroon;font-weight:700">return</span> <span style="color:#0f4d75">null</span><span style="color:purple">;</span>
<span style="color:purple">}</span><span style="color:purple">;</span>
</pre>
<p>We then need to create our variable for both required and optional authenticatiion methods and then finally export that variable:</p>
<pre style="color:#000;background:#fff"><span style="color:maroon;font-weight:700">const</span> auth <span style="color:#808030">=</span> <span style="color:purple">{</span>
  required<span style="color:purple">:</span> jwt<span style="color:#808030">(</span><span style="color:purple">{</span>
    secret<span style="color:purple">:</span> <span style="color:maroon">'</span><span style="color:#0000e6">secret</span><span style="color:maroon">'</span><span style="color:#808030">,</span>
    userProperty<span style="color:purple">:</span> <span style="color:maroon">'</span><span style="color:#0000e6">payload</span><span style="color:maroon">'</span><span style="color:#808030">,</span>
    getToken<span style="color:purple">:</span> getJWT<span style="color:#808030">,</span>
  <span style="color:purple">}</span><span style="color:#808030">)</span><span style="color:#808030">,</span>
  optional<span style="color:purple">:</span> jwt<span style="color:#808030">(</span><span style="color:purple">{</span>
    secret<span style="color:purple">:</span> <span style="color:maroon">'</span><span style="color:#0000e6">secret</span><span style="color:maroon">'</span><span style="color:#808030">,</span>
    userProperty<span style="color:purple">:</span> <span style="color:maroon">'</span><span style="color:#0000e6">payload</span><span style="color:maroon">'</span><span style="color:#808030">,</span>
    getToken<span style="color:purple">:</span> getJWT<span style="color:#808030">,</span>
    credentialsRequired<span style="color:purple">:</span> <span style="color:#0f4d75">false</span><span style="color:#808030">,</span>
  <span style="color:purple">}</span><span style="color:#808030">)</span><span style="color:#808030">,</span>
<span style="color:purple">}</span><span style="color:purple">;</span>

module<span style="color:#808030">.</span>exports <span style="color:#808030">=</span> auth<span style="color:purple">;</span>
</pre>
<p>Now we need to link all of this to an API.</p>
<p>To do that, create a new file in your routes folder called “index.js” and add the following code to it:</p>
<pre style="color:#000;background:#fff"><span style="color:maroon;font-weight:700">const</span> express <span style="color:#808030">=</span> require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">express</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:maroon;font-weight:700">const</span> router <span style="color:#808030">=</span> express<span style="color:#808030">.</span>Router<span style="color:#808030">(</span><span style="color:#808030">)</span><span style="color:purple">;</span>

router<span style="color:#808030">.</span>use<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">/api</span><span style="color:maroon">'</span><span style="color:#808030">,</span> require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">./api</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:#808030">)</span><span style="color:purple">;</span>

module<span style="color:#808030">.</span>exports <span style="color:#808030">=</span> router<span style="color:purple">;</span>
</pre>
<p>This will basically set up a new route that will link requests with the api pathname to a folder called api within our routes folder.</p>
<p>Create that api folder within your routes folder and then create another “index.js” file within that folder with the following:</p>
<pre style="color:#000;background:#fff"><span style="color:maroon;font-weight:700">const</span> express <span style="color:#808030">=</span> require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">express</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:maroon;font-weight:700">const</span> router <span style="color:#808030">=</span> express<span style="color:#808030">.</span>Router<span style="color:#808030">(</span><span style="color:#808030">)</span><span style="color:purple">;</span>

router<span style="color:#808030">.</span>use<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">/users</span><span style="color:maroon">'</span><span style="color:#808030">,</span> require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">./users</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:#808030">)</span><span style="color:purple">;</span>

module<span style="color:#808030">.</span>exports <span style="color:#808030">=</span> router<span style="color:purple">;</span>
</pre>
<p>And then, as you might have guessed from the code, we will need to create another file within the api folder called “users.js”.</p>
<p>This is . where you will host your users APIs.</p>
<h2>Creating your Users APIs</h2>
<p>To start off, add the following to the top of your new file:</p>
<pre style="color:#000;background:#fff"><span style="color:maroon;font-weight:700">const</span> mongoose <span style="color:#808030">=</span> require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">mongoose</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:maroon;font-weight:700">const</span> passport <span style="color:#808030">=</span> require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">passport</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:maroon;font-weight:700">const</span> router <span style="color:#808030">=</span> require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">express</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:#808030">.</span>Router<span style="color:#808030">(</span><span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:maroon;font-weight:700">const</span> auth <span style="color:#808030">=</span> require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">../auth</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:maroon;font-weight:700">const</span> Users <span style="color:#808030">=</span> mongoose<span style="color:#808030">.</span>model<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">Users</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>
</pre>
<p>You’ll then need to add the following after that to register your APIs.</p>
<p><strong>New user API</strong></p>
<pre style="color:#000;background:#fff">router<span style="color:#808030">.</span>post<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">/</span><span style="color:maroon">'</span><span style="color:#808030">,</span> auth<span style="color:#808030">.</span>optional<span style="color:#808030">,</span> <span style="color:#808030">(</span>req<span style="color:#808030">,</span> res<span style="color:#808030">,</span> next<span style="color:#808030">)</span> <span style="color:#808030">=</span><span style="color:#808030">></span> <span style="color:purple">{</span>
  <span style="color:maroon;font-weight:700">const</span> <span style="color:purple">{</span> body<span style="color:purple">:</span> <span style="color:purple">{</span> user <span style="color:purple">}</span> <span style="color:purple">}</span> <span style="color:#808030">=</span> req<span style="color:purple">;</span>

  <span style="color:maroon;font-weight:700">if</span><span style="color:#808030">(</span><span style="color:#808030">!</span>user<span style="color:#808030">.</span>email<span style="color:#808030">)</span> <span style="color:purple">{</span>
    <span style="color:maroon;font-weight:700">return</span> res<span style="color:#808030">.</span>status<span style="color:#808030">(</span><span style="color:#008c00">422</span><span style="color:#808030">)</span><span style="color:#808030">.</span>send<span style="color:#808030">(</span><span style="color:maroon">"</span><span style="color:#0000e6">Something unexpected happened</span><span style="color:maroon">"</span><span style="color:#808030">)</span><span style="color:purple">;</span>
  <span style="color:purple">}</span>

  <span style="color:maroon;font-weight:700">if</span><span style="color:#808030">(</span><span style="color:#808030">!</span>user<span style="color:#808030">.</span>password<span style="color:#808030">)</span> <span style="color:purple">{</span>
    <span style="color:maroon;font-weight:700">return</span> res<span style="color:#808030">.</span>status<span style="color:#808030">(</span><span style="color:#008c00">422</span><span style="color:#808030">)</span><span style="color:#808030">.</span>send<span style="color:#808030">(</span><span style="color:maroon">"</span><span style="color:#0000e6">Something unexpected happened</span><span style="color:maroon">"</span><span style="color:#808030">)</span><span style="color:purple">;</span>
  <span style="color:purple">}</span>

  <span style="color:maroon;font-weight:700">const</span> returnedUser <span style="color:#808030">=</span> <span style="color:maroon;font-weight:700">new</span> Users<span style="color:#808030">(</span>user<span style="color:#808030">)</span><span style="color:purple">;</span>

  returnedUser<span style="color:#808030">.</span>setPassword<span style="color:#808030">(</span>user<span style="color:#808030">.</span>password<span style="color:#808030">)</span><span style="color:purple">;</span>

  <span style="color:maroon;font-weight:700">return</span> returnedUser<span style="color:#808030">.</span>save<span style="color:#808030">(</span><span style="color:#808030">)</span>
    <span style="color:#808030">.</span>then<span style="color:#808030">(</span><span style="color:#808030">(</span><span style="color:#808030">)</span> <span style="color:#808030">=</span><span style="color:#808030">></span> res<span style="color:#808030">.</span>json<span style="color:#808030">(</span><span style="color:purple">{</span> user<span style="color:purple">:</span> returnedUser<span style="color:#808030">.</span>toAuthJSON<span style="color:#808030">(</span><span style="color:#808030">)</span> <span style="color:purple">}</span><span style="color:#808030">)</span><span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:purple">}</span><span style="color:#808030">)</span><span style="color:purple">;</span>
</pre>
<p><strong>Login API</strong></p>
<pre style="color:#000;background:#fff">router<span style="color:#808030">.</span>post<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">/login</span><span style="color:maroon">'</span><span style="color:#808030">,</span> auth<span style="color:#808030">.</span>optional<span style="color:#808030">,</span> <span style="color:#808030">(</span>req<span style="color:#808030">,</span> res<span style="color:#808030">,</span> next<span style="color:#808030">)</span> <span style="color:#808030">=</span><span style="color:#808030">></span> <span style="color:purple">{</span>
  <span style="color:maroon;font-weight:700">const</span> <span style="color:purple">{</span> body<span style="color:purple">:</span> <span style="color:purple">{</span> user <span style="color:purple">}</span> <span style="color:purple">}</span> <span style="color:#808030">=</span> req<span style="color:purple">;</span>

  <span style="color:maroon;font-weight:700">if</span><span style="color:#808030">(</span><span style="color:#808030">!</span>user<span style="color:#808030">.</span>email<span style="color:#808030">)</span> <span style="color:purple">{</span>
    <span style="color:maroon;font-weight:700">return</span> res<span style="color:#808030">.</span>status<span style="color:#808030">(</span><span style="color:#008c00">422</span><span style="color:#808030">)</span><span style="color:purple">;</span>
  <span style="color:purple">}</span>

  <span style="color:maroon;font-weight:700">if</span><span style="color:#808030">(</span><span style="color:#808030">!</span>user<span style="color:#808030">.</span>password<span style="color:#808030">)</span> <span style="color:purple">{</span>
    <span style="color:maroon;font-weight:700">return</span> res<span style="color:#808030">.</span>status<span style="color:#808030">(</span><span style="color:#008c00">422</span><span style="color:#808030">)</span><span style="color:purple">;</span>
  <span style="color:purple">}</span>

  <span style="color:maroon;font-weight:700">return</span> passport<span style="color:#808030">.</span>authenticate<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">local</span><span style="color:maroon">'</span><span style="color:#808030">,</span> <span style="color:purple">{</span> session<span style="color:purple">:</span> <span style="color:#0f4d75">false</span> <span style="color:purple">}</span><span style="color:#808030">,</span> <span style="color:#808030">(</span>err<span style="color:#808030">,</span> passportUser<span style="color:#808030">,</span> info<span style="color:#808030">)</span> <span style="color:#808030">=</span><span style="color:#808030">></span> <span style="color:purple">{</span>
    <span style="color:maroon;font-weight:700">if</span><span style="color:#808030">(</span>err<span style="color:#808030">)</span> <span style="color:purple">{</span>
      <span style="color:maroon;font-weight:700">return</span> next<span style="color:#808030">(</span>err<span style="color:#808030">)</span><span style="color:purple">;</span>
    <span style="color:purple">}</span>

    <span style="color:maroon;font-weight:700">if</span><span style="color:#808030">(</span>passportUser<span style="color:#808030">)</span> <span style="color:purple">{</span>
      <span style="color:maroon;font-weight:700">const</span> user <span style="color:#808030">=</span> passportUser<span style="color:purple">;</span>
      user<span style="color:#808030">.</span>token <span style="color:#808030">=</span> passportUser<span style="color:#808030">.</span>generateJWT<span style="color:#808030">(</span><span style="color:#808030">)</span><span style="color:purple">;</span>

      <span style="color:maroon;font-weight:700">return</span> res<span style="color:#808030">.</span>json<span style="color:#808030">(</span><span style="color:purple">{</span> user<span style="color:purple">:</span> user<span style="color:#808030">.</span>toAuthJSON<span style="color:#808030">(</span><span style="color:#808030">)</span> <span style="color:purple">}</span><span style="color:#808030">)</span><span style="color:purple">;</span>
    <span style="color:purple">}</span>

    <span style="color:maroon;font-weight:700">return</span> status<span style="color:#808030">(</span><span style="color:#008c00">400</span><span style="color:#808030">)</span><span style="color:#808030">.</span>info<span style="color:purple">;</span>
  <span style="color:purple">}</span><span style="color:#808030">)</span><span style="color:#808030">(</span>req<span style="color:#808030">,</span> res<span style="color:#808030">,</span> next<span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:purple">}</span><span style="color:#808030">)</span><span style="color:purple">;</span>
</pre>
<h2>Adding authentication to our APIs</h2>
<p>Now you are ready to add authentication to your APIs! Here’s an example with the addpost API that I talked about in the last post about creating a blog within Mongo:</p>
<pre style="color:#000;background:#fff"><span style="color:maroon;font-weight:700">const</span> mongoose <span style="color:#808030">=</span> require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">mongoose</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:maroon;font-weight:700">const</span> passport <span style="color:#808030">=</span> require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">passport</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:maroon;font-weight:700">const</span> router <span style="color:#808030">=</span> require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">express</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:#808030">.</span>Router<span style="color:#808030">(</span><span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:maroon;font-weight:700">const</span> auth <span style="color:#808030">=</span> require<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">../auth</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:maroon;font-weight:700">const</span> Users <span style="color:#808030">=</span> mongoose<span style="color:#808030">.</span>model<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">Users</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:maroon;font-weight:700">const</span> Post <span style="color:#808030">=</span> mongoose<span style="color:#808030">.</span>model<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">Post</span><span style="color:maroon">'</span><span style="color:#808030">)</span><span style="color:purple">;</span>

<span style="color:#696969">// For creating posts</span>
router<span style="color:#808030">.</span>post<span style="color:#808030">(</span><span style="color:maroon">'</span><span style="color:#0000e6">/addpost</span><span style="color:maroon">'</span><span style="color:#808030">,</span> auth<span style="color:#808030">.</span>required<span style="color:#808030">,</span> <span style="color:#808030">(</span>req<span style="color:#808030">,</span> res<span style="color:#808030">)</span> <span style="color:#808030">=</span><span style="color:#808030">></span> <span style="color:purple">{</span>
  <span style="color:maroon;font-weight:700">const</span> <span style="color:purple">{</span> payload<span style="color:purple">:</span> <span style="color:purple">{</span> id <span style="color:purple">}</span> <span style="color:purple">}</span> <span style="color:#808030">=</span> req<span style="color:purple">;</span>

  <span style="color:maroon;font-weight:700">return</span> Users<span style="color:#808030">.</span>findById<span style="color:#808030">(</span>id<span style="color:#808030">)</span>
    <span style="color:#808030">.</span>then<span style="color:#808030">(</span><span style="color:#808030">(</span>user<span style="color:#808030">)</span> <span style="color:#808030">=</span><span style="color:#808030">></span> <span style="color:purple">{</span>
      <span style="color:maroon;font-weight:700">if</span> <span style="color:#808030">(</span><span style="color:#808030">!</span>user<span style="color:#808030">)</span> <span style="color:purple">{</span>
        <span style="color:maroon;font-weight:700">return</span> res<span style="color:#808030">.</span>sendStatus<span style="color:#808030">(</span><span style="color:#008c00">400</span><span style="color:#808030">)</span><span style="color:purple">;</span>
      <span style="color:purple">}</span>

      <span style="color:maroon;font-weight:700">var</span> postData <span style="color:#808030">=</span> <span style="color:maroon;font-weight:700">new</span> Post<span style="color:#808030">(</span>req<span style="color:#808030">.</span>body<span style="color:#808030">)</span><span style="color:purple">;</span>
      postData<span style="color:#808030">.</span>save<span style="color:#808030">(</span><span style="color:#808030">)</span><span style="color:#808030">.</span>then<span style="color:#808030">(</span>result <span style="color:#808030">=</span><span style="color:#808030">></span> <span style="color:purple">{</span>
        res<span style="color:#808030">.</span>status<span style="color:#808030">(</span><span style="color:#008c00">200</span><span style="color:#808030">)</span><span style="color:#808030">.</span>send<span style="color:#808030">(</span><span style="color:maroon">"</span><span style="color:#0000e6">Post saved.</span><span style="color:maroon">"</span><span style="color:#808030">)</span><span style="color:purple">;</span>
      <span style="color:purple">}</span><span style="color:#808030">)</span><span style="color:#808030">.</span><span style="color:maroon;font-weight:700">catch</span><span style="color:#808030">(</span>err <span style="color:#808030">=</span><span style="color:#808030">></span> <span style="color:purple">{</span>
        res<span style="color:#808030">.</span>status<span style="color:#808030">(</span><span style="color:#008c00">400</span><span style="color:#808030">)</span><span style="color:#808030">.</span>send<span style="color:#808030">(</span><span style="color:maroon">"</span><span style="color:#0000e6">Unable to save data</span><span style="color:maroon">"</span><span style="color:#808030">)</span><span style="color:purple">;</span>
      <span style="color:purple">}</span><span style="color:#808030">)</span><span style="color:purple">;</span>
    <span style="color:purple">}</span><span style="color:#808030">)</span><span style="color:purple">;</span>
<span style="color:purple">}</span><span style="color:#808030">)</span><span style="color:purple">;</span>
</pre>
<h2>And that’s it!</h2>
<p>You have now successfully added authentication to your Node Express setup. Next up is creating a full frontend system with a login and dashboard page for our blog</p>
<p><img src="https://media.giphy.com/media/bWS1Vh9mVkcZq/giphy.gif" alt=""></p>
</div></div></div></div> <link rel="stylesheet" href="/css/dracula.min.css"> <script>
  window.onload = function() {
    if (&quot;serviceWorker&quot; in navigator) {
      const offlineButton = document.createElement(&quot;button&quot;);

      offlineButton.className = &quot;button&quot;;

      caches.open(&quot;SavedPages&quot;).then(function(cache) {
        cache.match(window.location.href).then(function(result) {
          if (result) {
            document
              .querySelector(&quot;.post-buttons-wrapper&quot;)
              .appendChild(offlineButton);
            offlineButton.innerText =
              &quot;This page is ready for offline reading 👍🏻&quot;;
            offlineButton.setAttribute(&quot;disabled&quot;, &quot;disabled&quot;);
          } else {
            document
              .querySelector(&quot;.post-buttons-wrapper&quot;)
              .appendChild(offlineButton);
            offlineButton.innerText = &quot;Save this page for offline reading&quot;;
          }
        });
      });

      caches.open(&quot;cachedPages&quot;).then(function(cache) {
        cache.match(window.location.href).then(function(result) {
          if (result) {
            document
              .querySelector(&quot;.post-buttons-wrapper&quot;)
              .appendChild(offlineButton);
            offlineButton.innerText =
              &quot;This page is ready for offline reading 👍🏻&quot;;
            offlineButton.setAttribute(&quot;disabled&quot;, &quot;disabled&quot;);
          } else {
            document
              .querySelector(&quot;.post-buttons-wrapper&quot;)
              .appendChild(offlineButton);
            offlineButton.innerText = &quot;Save this page&quot;;
          }
        });
      });

      offlineButton.addEventListener(&quot;click&quot;, function(ev) {
        ev.preventDefault();

        var btn = this;

        btn.innerText = &quot;Saving...&quot;;

        caches.open(&quot;SavedPages&quot;).then(function(cache) {
          cache.add(window.location.href).then(function() {
            const data = {
              title: document.querySelector(&quot;title&quot;).innerText
            };

            localStorage.setItem(window.location.href, JSON.stringify(data));

            btn.innerText = &quot;This page is ready for offline reading 👍🏻&quot;;
            btn.setAttribute(&quot;disabled&quot;, &quot;disabled&quot;);
          });
        });
      });
    }
  };
    </script></div> <div hidden class="cookies js-cookie-message"><div class="cookies__box"><p><strong>
            Another 🍪
            notification.
          </strong> <br>Sorry to bug you, I know these are annoying, just letting you know that I
          am
          using cookies on this site to track analytics, annoymously of course.
        </p> <button class="button button--primary">That's fine</button></div></div> <link href="/css/main.15f091f2.css" rel="stylesheet"> <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet"> <script>window.Promise||document.write("&lt;script src=&quot;js/es6-promise.min.js&quot; &gt;&lt;/script&gt;"),window.fetch||document.write("&lt;script src=&quot;js/fetch.min.js&quot;&gt;&lt;/script&gt;")</script> <script type="text/javascript">
    window.addEventListener(&quot;DOMContentLoaded&quot;, function (event) {
        // Load the service worker
        if ('serviceWorker' in navigator) {

            navigator.serviceWorker.register('/serviceworker.js', { scope: '/'}) 

            .then( function( registration) {
                console.log(`Service Worker successfully registered for`, registration.scope);
            } )

            .catch( function( error ) {
                console.log(`ServiceWorker not registered: ${error}`);
            } );

            if(navigator.serviceWorker.controller) {
                window.addEventListener('load', function() {
                    navigator.serviceWorker.controller.postMessage({'command': 'trimCaches'});
                })
            }
        }
    });
</script> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NK46QBJ" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript></div></div></div><script>window.__NUXT__=function(s,o,n,a,l,p,e,t,r,c,y){return{layout:"default",data:[{attributes:{title:l,published:s,description:p,tags:a,thumbnail:o,header:o,ctime:new Date(1555632e6)},content:'<p>In the last blog post we talked about <a href="../../../../../../../../post-single?postID=5c7be6e2a1e5fbe51cd94950">adding a blog to our personal site via Node, Express and Mongo</a>. In this blog post, we will be expanding upon that by adding authentication to our new Express APIs via something called Passport.js.</p>\n<p>We will be going through the backend side of the code only during this post, creating a set of APIs for creating users, generating tokens for users, logging users in and requiring authentication for our APIs.</p>\n<p>Let’s get started.</p>\n<h2>Setting up our app</h2>\n<p>For this post, I am going to expect that you have already set up a node environment, and have Mongo set up and ready to go. If you still need to do that, then it might be best to find a tutorial on how to do that before you follow this.</p>\n<p>To start, you’ll need to make sure that you have the following packages installed and included within your main application file:</p>\n<pre>const express = require(\'express\');\nconst path = require(\'path\');\nconst bodyParser = require(\'body-parser\');\nconst session = require(\'express-session\');\nconst cors = require(\'cors\');\nconst mongoose = require(\'mongoose\');\n</pre>\n<p>Now you will need to configure Mongose to use global promises and setup Express to use your modules and set up your sessions.</p>\n<pre style="color: #000000; background: #ffffff;"><span style="color: #696969;">//Configure mongoose\'s promise to global promise</span>\nmongoose<span style="color: #808030;">.</span>promise <span style="color: #808030;">=</span> <span style="color: #797997;">global</span><span style="color: #808030;">.</span>Promise<span style="color: #800080;">;</span>\n\n<span style="color: #696969;">//Initiate our app</span>\n<span style="color: #800000; font-weight: bold;">const</span> app <span style="color: #808030;">=</span> express<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n\n<span style="color: #696969;">//Configure our app</span>\napp<span style="color: #808030;">.</span>use<span style="color: #808030;">(</span>cors<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\napp<span style="color: #808030;">.</span>use<span style="color: #808030;">(</span>require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">morgan</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">dev</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\napp<span style="color: #808030;">.</span>use<span style="color: #808030;">(</span>bodyParser<span style="color: #808030;">.</span>urlencoded<span style="color: #808030;">(</span><span style="color: #800080;">{</span> extended<span style="color: #800080;">:</span> <span style="color: #0f4d75;">false</span> <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\napp<span style="color: #808030;">.</span>use<span style="color: #808030;">(</span>bodyParser<span style="color: #808030;">.</span>json<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\napp<span style="color: #808030;">.</span>use<span style="color: #808030;">(</span>express<span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">static</span><span style="color: #808030;">(</span>path<span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">join</span><span style="color: #808030;">(</span>__dirname<span style="color: #808030;">,</span> <span style="color: #800000;">\'</span><span style="color: #0000e6;">public</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\napp<span style="color: #808030;">.</span>use<span style="color: #808030;">(</span>session<span style="color: #808030;">(</span><span style="color: #800080;">{</span> secret<span style="color: #800080;">:</span> <span style="color: #800000;">\'</span><span style="color: #0000e6;">my-super-secret-key</span><span style="color: #800000;">\'</span><span style="color: #808030;">,</span> cookie<span style="color: #800080;">:</span> <span style="color: #800080;">{</span> maxAge<span style="color: #800080;">:</span> <span style="color: #008c00;">60000</span> <span style="color: #800080;">}</span><span style="color: #808030;">,</span> resave<span style="color: #800080;">:</span> <span style="color: #0f4d75;">false</span><span style="color: #808030;">,</span> saveUninitialized<span style="color: #800080;">:</span> <span style="color: #0f4d75;">false</span> <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n</pre>\n<p>Make sure that you change your key to something really secret.</p>\n<h2>Storing user data</h2>\n<p>Now that you have set up and configured your app, you will need to create your model for the Users database that you will need for the next steps.</p>\n<p>To do this, you will need to create a new folder called “models” and then create a file within that folder called “Users.js”.</p>\n<p>We will be using this folder to define the schema for our users, hashing user passwords, generating a salt and creating the JWT that we will need latter. This file should look something like this:</p>\n<pre style="color: #000000; background: #ffffff;"><span style="color: #800000; font-weight: bold;">const</span> mongoose <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">mongoose</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800000; font-weight: bold;">const</span> crypto <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">crypto</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800000; font-weight: bold;">const</span> jwt <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">jsonwebtoken</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n\n<span style="color: #800000; font-weight: bold;">const</span> <span style="color: #800080;">{</span> Schema <span style="color: #800080;">}</span> <span style="color: #808030;">=</span> mongoose<span style="color: #800080;">;</span>\n\n<span style="color: #800000; font-weight: bold;">const</span> UsersSchema <span style="color: #808030;">=</span> <span style="color: #800000; font-weight: bold;">new</span> Schema<span style="color: #808030;">(</span><span style="color: #800080;">{</span>\n  email<span style="color: #800080;">:</span> <span style="color: #797997;">String</span><span style="color: #808030;">,</span>\n  hash<span style="color: #800080;">:</span> <span style="color: #797997;">String</span><span style="color: #808030;">,</span>\n  salt<span style="color: #800080;">:</span> <span style="color: #797997;">String</span><span style="color: #808030;">,</span>\n<span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n\nUsersSchema<span style="color: #808030;">.</span>methods<span style="color: #808030;">.</span>setPassword <span style="color: #808030;">=</span> <span style="color: #800000; font-weight: bold;">function</span><span style="color: #808030;">(</span>password<span style="color: #808030;">)</span> <span style="color: #800080;">{</span>\n  <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>salt <span style="color: #808030;">=</span> crypto<span style="color: #808030;">.</span>randomBytes<span style="color: #808030;">(</span><span style="color: #008c00;">16</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">toString</span><span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">hex</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n  <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>hash <span style="color: #808030;">=</span> crypto<span style="color: #808030;">.</span>pbkdf2Sync<span style="color: #808030;">(</span>password<span style="color: #808030;">,</span> <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>salt<span style="color: #808030;">,</span> <span style="color: #008c00;">10000</span><span style="color: #808030;">,</span> <span style="color: #008c00;">512</span><span style="color: #808030;">,</span> <span style="color: #800000;">\'</span><span style="color: #0000e6;">sha512</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">toString</span><span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">hex</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800080;">}</span><span style="color: #800080;">;</span>\n\nUsersSchema<span style="color: #808030;">.</span>methods<span style="color: #808030;">.</span>validatePassword <span style="color: #808030;">=</span> <span style="color: #800000; font-weight: bold;">function</span><span style="color: #808030;">(</span>password<span style="color: #808030;">)</span> <span style="color: #800080;">{</span>\n  <span style="color: #800000; font-weight: bold;">const</span> hash <span style="color: #808030;">=</span> crypto<span style="color: #808030;">.</span>pbkdf2Sync<span style="color: #808030;">(</span>password<span style="color: #808030;">,</span> <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>salt<span style="color: #808030;">,</span> <span style="color: #008c00;">10000</span><span style="color: #808030;">,</span> <span style="color: #008c00;">512</span><span style="color: #808030;">,</span> <span style="color: #800000;">\'</span><span style="color: #0000e6;">sha512</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">toString</span><span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">hex</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n  <span style="color: #800000; font-weight: bold;">return</span> <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>hash <span style="color: #808030;">===</span> hash<span style="color: #800080;">;</span>\n<span style="color: #800080;">}</span><span style="color: #800080;">;</span>\n\nUsersSchema<span style="color: #808030;">.</span>methods<span style="color: #808030;">.</span>generateJWT <span style="color: #808030;">=</span> <span style="color: #800000; font-weight: bold;">function</span><span style="color: #808030;">(</span><span style="color: #808030;">)</span> <span style="color: #800080;">{</span>\n  <span style="color: #800000; font-weight: bold;">const</span> today <span style="color: #808030;">=</span> <span style="color: #800000; font-weight: bold;">new</span> <span style="color: #797997;">Date</span><span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n  <span style="color: #800000; font-weight: bold;">const</span> expirationDate <span style="color: #808030;">=</span> <span style="color: #800000; font-weight: bold;">new</span> <span style="color: #797997;">Date</span><span style="color: #808030;">(</span>today<span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n  expirationDate<span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">setDate</span><span style="color: #808030;">(</span>today<span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">getDate</span><span style="color: #808030;">(</span><span style="color: #808030;">)</span> <span style="color: #808030;">+</span> <span style="color: #008c00;">60</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n\n  <span style="color: #800000; font-weight: bold;">return</span> jwt<span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">sign</span><span style="color: #808030;">(</span><span style="color: #800080;">{</span>\n    email<span style="color: #800080;">:</span> <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>email<span style="color: #808030;">,</span>\n    id<span style="color: #800080;">:</span> <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>_id<span style="color: #808030;">,</span>\n    <span style="color: #800000; font-weight: bold;">exp</span><span style="color: #800080;">:</span> <span style="color: #800000; font-weight: bold;">parseInt</span><span style="color: #808030;">(</span>expirationDate<span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">getTime</span><span style="color: #808030;">(</span><span style="color: #808030;">)</span> <span style="color: #808030;">/</span> <span style="color: #008c00;">1000</span><span style="color: #808030;">,</span> <span style="color: #008c00;">10</span><span style="color: #808030;">)</span><span style="color: #808030;">,</span>\n  <span style="color: #800080;">}</span><span style="color: #808030;">,</span> <span style="color: #800000;">\'</span><span style="color: #0000e6;">secret</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800080;">}</span>\n\nUsersSchema<span style="color: #808030;">.</span>methods<span style="color: #808030;">.</span>toAuthJSON <span style="color: #808030;">=</span> <span style="color: #800000; font-weight: bold;">function</span><span style="color: #808030;">(</span><span style="color: #808030;">)</span> <span style="color: #800080;">{</span>\n  <span style="color: #800000; font-weight: bold;">return</span> <span style="color: #800080;">{</span>\n    _id<span style="color: #800080;">:</span> <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>_id<span style="color: #808030;">,</span>\n    email<span style="color: #800080;">:</span> <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>email<span style="color: #808030;">,</span>\n    token<span style="color: #800080;">:</span> <span style="color: #800000; font-weight: bold;">this</span><span style="color: #808030;">.</span>generateJWT<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #808030;">,</span>\n  <span style="color: #800080;">}</span><span style="color: #800080;">;</span>\n<span style="color: #800080;">}</span><span style="color: #800080;">;</span>\n\nmongoose<span style="color: #808030;">.</span>model<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">Users</span><span style="color: #800000;">\'</span><span style="color: #808030;">,</span> UsersSchema<span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n</pre>\n<p>To use this model, you will need to add the following to your application file under the line where you are settiing up Mongo.</p>\n<pre>require(\'./models/Users\');</pre>\n<h2>Setting up our Passport.js config</h2>\n<p>Now that we have set up our users model, we are ready to get started with our configuration for Passport.js.</p>\n<p>To do this and keep it tidy we will need to create a new folder called “config”, which we will be using for the storage of our configuration files for this part and for future requirements.</p>\n<p>Within this folder, we need to create a new file named “passport.js”.</p>\n<pre style="color: #000000; background: #ffffff;"><span style="color: #800000; font-weight: bold;">const</span> mongoose <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">mongoose</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800000; font-weight: bold;">const</span> passport <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">passport</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800000; font-weight: bold;">const</span> LocalStrategy <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">passport-local</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n\n<span style="color: #800000; font-weight: bold;">const</span> Users <span style="color: #808030;">=</span> mongoose<span style="color: #808030;">.</span>model<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">Users</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n\npassport<span style="color: #808030;">.</span>use<span style="color: #808030;">(</span><span style="color: #800000; font-weight: bold;">new</span> LocalStrategy<span style="color: #808030;">(</span><span style="color: #800080;">{</span>\n  usernameField<span style="color: #800080;">:</span> <span style="color: #800000;">\'</span><span style="color: #0000e6;">user[email]</span><span style="color: #800000;">\'</span><span style="color: #808030;">,</span>\n  passwordField<span style="color: #800080;">:</span> <span style="color: #800000;">\'</span><span style="color: #0000e6;">user[password]</span><span style="color: #800000;">\'</span><span style="color: #808030;">,</span>\n<span style="color: #800080;">}</span><span style="color: #808030;">,</span> <span style="color: #808030;">(</span>email<span style="color: #808030;">,</span> password<span style="color: #808030;">,</span> done<span style="color: #808030;">)</span> <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>\n  Users<span style="color: #808030;">.</span>findOne<span style="color: #808030;">(</span><span style="color: #800080;">{</span> email <span style="color: #800080;">}</span><span style="color: #808030;">)</span>\n    <span style="color: #808030;">.</span>then<span style="color: #808030;">(</span><span style="color: #808030;">(</span>user<span style="color: #808030;">)</span> <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>\n      <span style="color: #800000; font-weight: bold;">if</span><span style="color: #808030;">(</span><span style="color: #808030;">!</span>user <span style="color: #808030;">||</span> <span style="color: #808030;">!</span>user<span style="color: #808030;">.</span>validatePassword<span style="color: #808030;">(</span>password<span style="color: #808030;">)</span><span style="color: #808030;">)</span> <span style="color: #800080;">{</span>\n        <span style="color: #800000; font-weight: bold;">return</span> done<span style="color: #808030;">(</span><span style="color: #0f4d75;">null</span><span style="color: #808030;">,</span> <span style="color: #0f4d75;">false</span><span style="color: #808030;">,</span> <span style="color: #800080;">{</span> errors<span style="color: #800080;">:</span> <span style="color: #800080;">{</span> <span style="color: #800000;">\'</span><span style="color: #0000e6;">email or password</span><span style="color: #800000;">\'</span><span style="color: #800080;">:</span> <span style="color: #800000;">\'</span><span style="color: #0000e6;">is invalid</span><span style="color: #800000;">\'</span> <span style="color: #800080;">}</span> <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n      <span style="color: #800080;">}</span>\n\n      <span style="color: #800000; font-weight: bold;">return</span> done<span style="color: #808030;">(</span><span style="color: #0f4d75;">null</span><span style="color: #808030;">,</span> user<span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n    <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">catch</span><span style="color: #808030;">(</span>done<span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n</pre>\n<p>This will basically use our password validation function from users to direct the user to the correct output.</p>\n<p>To link this all together, you will need to add the following line after your model set up:</p>\n<pre style="color: #000000; background: #ffffff;">require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">./config/passport</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n</pre>\n<h2>Setting up our authentication route</h2>\n<p>The final step is to set up a route that can be used for authentication.</p>\n<p>To do this, we will create a new folder named “routes” and then within that, we will create a file named “auth.js”. This will contain a function for getting a token from the user’s request headers.</p>\n<p>It does this by looking for a header named authorization and then splitting everything in the value after the word ‘Token’, the part that is returned should be our JWT.</p>\n<p>If a JWT cannnot be found it will return null, which we can use to display an error through the API later.</p>\n<pre style="color: #000000; background: #ffffff;"><span style="color: #800000; font-weight: bold;">const</span> jwt <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">express-jwt</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n\n<span style="color: #800000; font-weight: bold;">const</span> getJWT <span style="color: #808030;">=</span> <span style="color: #808030;">(</span>req<span style="color: #808030;">)</span> <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>\n  <span style="color: #800000; font-weight: bold;">const</span> <span style="color: #800080;">{</span> headers<span style="color: #800080;">:</span> <span style="color: #800080;">{</span> authorization <span style="color: #800080;">}</span> <span style="color: #800080;">}</span> <span style="color: #808030;">=</span> req<span style="color: #800080;">;</span>\n\n  <span style="color: #800000; font-weight: bold;">if</span><span style="color: #808030;">(</span>authorization <span style="color: #808030;">&&</span> authorization<span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">split</span><span style="color: #808030;">(</span><span style="color: #800000;">\'</span> <span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #808030;">[</span><span style="color: #008c00;">0</span><span style="color: #808030;">]</span> <span style="color: #808030;">===</span> <span style="color: #800000;">\'</span><span style="color: #0000e6;">Token</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span> <span style="color: #800080;">{</span>\n    <span style="color: #800000; font-weight: bold;">return</span> authorization<span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">split</span><span style="color: #808030;">(</span><span style="color: #800000;">\'</span> <span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #808030;">[</span><span style="color: #008c00;">1</span><span style="color: #808030;">]</span><span style="color: #800080;">;</span>\n  <span style="color: #800080;">}</span>\n  <span style="color: #800000; font-weight: bold;">return</span> <span style="color: #0f4d75;">null</span><span style="color: #800080;">;</span>\n<span style="color: #800080;">}</span><span style="color: #800080;">;</span>\n</pre>\n<p>We then need to create our variable for both required and optional authenticatiion methods and then finally export that variable:</p>\n<pre style="color: #000000; background: #ffffff;"><span style="color: #800000; font-weight: bold;">const</span> auth <span style="color: #808030;">=</span> <span style="color: #800080;">{</span>\n  required<span style="color: #800080;">:</span> jwt<span style="color: #808030;">(</span><span style="color: #800080;">{</span>\n    secret<span style="color: #800080;">:</span> <span style="color: #800000;">\'</span><span style="color: #0000e6;">secret</span><span style="color: #800000;">\'</span><span style="color: #808030;">,</span>\n    userProperty<span style="color: #800080;">:</span> <span style="color: #800000;">\'</span><span style="color: #0000e6;">payload</span><span style="color: #800000;">\'</span><span style="color: #808030;">,</span>\n    getToken<span style="color: #800080;">:</span> getJWT<span style="color: #808030;">,</span>\n  <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #808030;">,</span>\n  optional<span style="color: #800080;">:</span> jwt<span style="color: #808030;">(</span><span style="color: #800080;">{</span>\n    secret<span style="color: #800080;">:</span> <span style="color: #800000;">\'</span><span style="color: #0000e6;">secret</span><span style="color: #800000;">\'</span><span style="color: #808030;">,</span>\n    userProperty<span style="color: #800080;">:</span> <span style="color: #800000;">\'</span><span style="color: #0000e6;">payload</span><span style="color: #800000;">\'</span><span style="color: #808030;">,</span>\n    getToken<span style="color: #800080;">:</span> getJWT<span style="color: #808030;">,</span>\n    credentialsRequired<span style="color: #800080;">:</span> <span style="color: #0f4d75;">false</span><span style="color: #808030;">,</span>\n  <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #808030;">,</span>\n<span style="color: #800080;">}</span><span style="color: #800080;">;</span>\n\nmodule<span style="color: #808030;">.</span>exports <span style="color: #808030;">=</span> auth<span style="color: #800080;">;</span>\n</pre>\n<p>Now we need to link all of this to an API.</p>\n<p>To do that, create a new file in your routes folder called “index.js” and add the following code to it:</p>\n<pre style="color: #000000; background: #ffffff;"><span style="color: #800000; font-weight: bold;">const</span> express <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">express</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800000; font-weight: bold;">const</span> router <span style="color: #808030;">=</span> express<span style="color: #808030;">.</span>Router<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n\nrouter<span style="color: #808030;">.</span>use<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">/api</span><span style="color: #800000;">\'</span><span style="color: #808030;">,</span> require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">./api</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n\nmodule<span style="color: #808030;">.</span>exports <span style="color: #808030;">=</span> router<span style="color: #800080;">;</span>\n</pre>\n<p>This will basically set up a new route that will link requests with the api pathname to a folder called api within our routes folder.</p>\n<p>Create that api folder within your routes folder and then create another “index.js” file within that folder with the following:</p>\n<pre style="color: #000000; background: #ffffff;"><span style="color: #800000; font-weight: bold;">const</span> express <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">express</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800000; font-weight: bold;">const</span> router <span style="color: #808030;">=</span> express<span style="color: #808030;">.</span>Router<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n\nrouter<span style="color: #808030;">.</span>use<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">/users</span><span style="color: #800000;">\'</span><span style="color: #808030;">,</span> require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">./users</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n\nmodule<span style="color: #808030;">.</span>exports <span style="color: #808030;">=</span> router<span style="color: #800080;">;</span>\n</pre>\n<p>And then, as you might have guessed from the code, we will need to create another file within the api folder called “users.js”.</p>\n<p>This is . where you will host your users APIs.</p>\n<h2>Creating your Users APIs</h2>\n<p>To start off, add the following to the top of your new file:</p>\n<pre style="color: #000000; background: #ffffff;"><span style="color: #800000; font-weight: bold;">const</span> mongoose <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">mongoose</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800000; font-weight: bold;">const</span> passport <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">passport</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800000; font-weight: bold;">const</span> router <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">express</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span>Router<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800000; font-weight: bold;">const</span> auth <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">../auth</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800000; font-weight: bold;">const</span> Users <span style="color: #808030;">=</span> mongoose<span style="color: #808030;">.</span>model<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">Users</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n</pre>\n<p>You’ll then need to add the following after that to register your APIs.</p>\n<p><strong>New user API</strong></p>\n<pre style="color: #000000; background: #ffffff;">router<span style="color: #808030;">.</span>post<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">/</span><span style="color: #800000;">\'</span><span style="color: #808030;">,</span> auth<span style="color: #808030;">.</span>optional<span style="color: #808030;">,</span> <span style="color: #808030;">(</span>req<span style="color: #808030;">,</span> res<span style="color: #808030;">,</span> next<span style="color: #808030;">)</span> <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>\n  <span style="color: #800000; font-weight: bold;">const</span> <span style="color: #800080;">{</span> body<span style="color: #800080;">:</span> <span style="color: #800080;">{</span> user <span style="color: #800080;">}</span> <span style="color: #800080;">}</span> <span style="color: #808030;">=</span> req<span style="color: #800080;">;</span>\n\n  <span style="color: #800000; font-weight: bold;">if</span><span style="color: #808030;">(</span><span style="color: #808030;">!</span>user<span style="color: #808030;">.</span>email<span style="color: #808030;">)</span> <span style="color: #800080;">{</span>\n    <span style="color: #800000; font-weight: bold;">return</span> res<span style="color: #808030;">.</span>status<span style="color: #808030;">(</span><span style="color: #008c00;">422</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span>send<span style="color: #808030;">(</span><span style="color: #800000;">"</span><span style="color: #0000e6;">Something unexpected happened</span><span style="color: #800000;">"</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n  <span style="color: #800080;">}</span>\n\n  <span style="color: #800000; font-weight: bold;">if</span><span style="color: #808030;">(</span><span style="color: #808030;">!</span>user<span style="color: #808030;">.</span>password<span style="color: #808030;">)</span> <span style="color: #800080;">{</span>\n    <span style="color: #800000; font-weight: bold;">return</span> res<span style="color: #808030;">.</span>status<span style="color: #808030;">(</span><span style="color: #008c00;">422</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span>send<span style="color: #808030;">(</span><span style="color: #800000;">"</span><span style="color: #0000e6;">Something unexpected happened</span><span style="color: #800000;">"</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n  <span style="color: #800080;">}</span>\n\n  <span style="color: #800000; font-weight: bold;">const</span> returnedUser <span style="color: #808030;">=</span> <span style="color: #800000; font-weight: bold;">new</span> Users<span style="color: #808030;">(</span>user<span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n\n  returnedUser<span style="color: #808030;">.</span>setPassword<span style="color: #808030;">(</span>user<span style="color: #808030;">.</span>password<span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n\n  <span style="color: #800000; font-weight: bold;">return</span> returnedUser<span style="color: #808030;">.</span>save<span style="color: #808030;">(</span><span style="color: #808030;">)</span>\n    <span style="color: #808030;">.</span>then<span style="color: #808030;">(</span><span style="color: #808030;">(</span><span style="color: #808030;">)</span> <span style="color: #808030;">=</span><span style="color: #808030;">></span> res<span style="color: #808030;">.</span>json<span style="color: #808030;">(</span><span style="color: #800080;">{</span> user<span style="color: #800080;">:</span> returnedUser<span style="color: #808030;">.</span>toAuthJSON<span style="color: #808030;">(</span><span style="color: #808030;">)</span> <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n</pre>\n<p><strong>Login API</strong></p>\n<pre style="color: #000000; background: #ffffff;">router<span style="color: #808030;">.</span>post<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">/login</span><span style="color: #800000;">\'</span><span style="color: #808030;">,</span> auth<span style="color: #808030;">.</span>optional<span style="color: #808030;">,</span> <span style="color: #808030;">(</span>req<span style="color: #808030;">,</span> res<span style="color: #808030;">,</span> next<span style="color: #808030;">)</span> <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>\n  <span style="color: #800000; font-weight: bold;">const</span> <span style="color: #800080;">{</span> body<span style="color: #800080;">:</span> <span style="color: #800080;">{</span> user <span style="color: #800080;">}</span> <span style="color: #800080;">}</span> <span style="color: #808030;">=</span> req<span style="color: #800080;">;</span>\n\n  <span style="color: #800000; font-weight: bold;">if</span><span style="color: #808030;">(</span><span style="color: #808030;">!</span>user<span style="color: #808030;">.</span>email<span style="color: #808030;">)</span> <span style="color: #800080;">{</span>\n    <span style="color: #800000; font-weight: bold;">return</span> res<span style="color: #808030;">.</span>status<span style="color: #808030;">(</span><span style="color: #008c00;">422</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n  <span style="color: #800080;">}</span>\n\n  <span style="color: #800000; font-weight: bold;">if</span><span style="color: #808030;">(</span><span style="color: #808030;">!</span>user<span style="color: #808030;">.</span>password<span style="color: #808030;">)</span> <span style="color: #800080;">{</span>\n    <span style="color: #800000; font-weight: bold;">return</span> res<span style="color: #808030;">.</span>status<span style="color: #808030;">(</span><span style="color: #008c00;">422</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n  <span style="color: #800080;">}</span>\n\n  <span style="color: #800000; font-weight: bold;">return</span> passport<span style="color: #808030;">.</span>authenticate<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">local</span><span style="color: #800000;">\'</span><span style="color: #808030;">,</span> <span style="color: #800080;">{</span> session<span style="color: #800080;">:</span> <span style="color: #0f4d75;">false</span> <span style="color: #800080;">}</span><span style="color: #808030;">,</span> <span style="color: #808030;">(</span>err<span style="color: #808030;">,</span> passportUser<span style="color: #808030;">,</span> info<span style="color: #808030;">)</span> <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>\n    <span style="color: #800000; font-weight: bold;">if</span><span style="color: #808030;">(</span>err<span style="color: #808030;">)</span> <span style="color: #800080;">{</span>\n      <span style="color: #800000; font-weight: bold;">return</span> next<span style="color: #808030;">(</span>err<span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n    <span style="color: #800080;">}</span>\n\n    <span style="color: #800000; font-weight: bold;">if</span><span style="color: #808030;">(</span>passportUser<span style="color: #808030;">)</span> <span style="color: #800080;">{</span>\n      <span style="color: #800000; font-weight: bold;">const</span> user <span style="color: #808030;">=</span> passportUser<span style="color: #800080;">;</span>\n      user<span style="color: #808030;">.</span>token <span style="color: #808030;">=</span> passportUser<span style="color: #808030;">.</span>generateJWT<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n\n      <span style="color: #800000; font-weight: bold;">return</span> res<span style="color: #808030;">.</span>json<span style="color: #808030;">(</span><span style="color: #800080;">{</span> user<span style="color: #800080;">:</span> user<span style="color: #808030;">.</span>toAuthJSON<span style="color: #808030;">(</span><span style="color: #808030;">)</span> <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n    <span style="color: #800080;">}</span>\n\n    <span style="color: #800000; font-weight: bold;">return</span> status<span style="color: #808030;">(</span><span style="color: #008c00;">400</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span>info<span style="color: #800080;">;</span>\n  <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #808030;">(</span>req<span style="color: #808030;">,</span> res<span style="color: #808030;">,</span> next<span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n</pre>\n<h2>Adding authentication to our APIs</h2>\n<p>Now you are ready to add authentication to your APIs! Here’s an example with the addpost API that I talked about in the last post about creating a blog within Mongo:</p>\n<pre style="color: #000000; background: #ffffff;"><span style="color: #800000; font-weight: bold;">const</span> mongoose <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">mongoose</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800000; font-weight: bold;">const</span> passport <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">passport</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800000; font-weight: bold;">const</span> router <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">express</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span>Router<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800000; font-weight: bold;">const</span> auth <span style="color: #808030;">=</span> require<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">../auth</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800000; font-weight: bold;">const</span> Users <span style="color: #808030;">=</span> mongoose<span style="color: #808030;">.</span>model<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">Users</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800000; font-weight: bold;">const</span> Post <span style="color: #808030;">=</span> mongoose<span style="color: #808030;">.</span>model<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">Post</span><span style="color: #800000;">\'</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n\n<span style="color: #696969;">// For creating posts</span>\nrouter<span style="color: #808030;">.</span>post<span style="color: #808030;">(</span><span style="color: #800000;">\'</span><span style="color: #0000e6;">/addpost</span><span style="color: #800000;">\'</span><span style="color: #808030;">,</span> auth<span style="color: #808030;">.</span>required<span style="color: #808030;">,</span> <span style="color: #808030;">(</span>req<span style="color: #808030;">,</span> res<span style="color: #808030;">)</span> <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>\n  <span style="color: #800000; font-weight: bold;">const</span> <span style="color: #800080;">{</span> payload<span style="color: #800080;">:</span> <span style="color: #800080;">{</span> id <span style="color: #800080;">}</span> <span style="color: #800080;">}</span> <span style="color: #808030;">=</span> req<span style="color: #800080;">;</span>\n\n  <span style="color: #800000; font-weight: bold;">return</span> Users<span style="color: #808030;">.</span>findById<span style="color: #808030;">(</span>id<span style="color: #808030;">)</span>\n    <span style="color: #808030;">.</span>then<span style="color: #808030;">(</span><span style="color: #808030;">(</span>user<span style="color: #808030;">)</span> <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>\n      <span style="color: #800000; font-weight: bold;">if</span> <span style="color: #808030;">(</span><span style="color: #808030;">!</span>user<span style="color: #808030;">)</span> <span style="color: #800080;">{</span>\n        <span style="color: #800000; font-weight: bold;">return</span> res<span style="color: #808030;">.</span>sendStatus<span style="color: #808030;">(</span><span style="color: #008c00;">400</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n      <span style="color: #800080;">}</span>\n\n      <span style="color: #800000; font-weight: bold;">var</span> postData <span style="color: #808030;">=</span> <span style="color: #800000; font-weight: bold;">new</span> Post<span style="color: #808030;">(</span>req<span style="color: #808030;">.</span>body<span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n      postData<span style="color: #808030;">.</span>save<span style="color: #808030;">(</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span>then<span style="color: #808030;">(</span>result <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>\n        res<span style="color: #808030;">.</span>status<span style="color: #808030;">(</span><span style="color: #008c00;">200</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span>send<span style="color: #808030;">(</span><span style="color: #800000;">"</span><span style="color: #0000e6;">Post saved.</span><span style="color: #800000;">"</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n      <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span><span style="color: #800000; font-weight: bold;">catch</span><span style="color: #808030;">(</span>err <span style="color: #808030;">=</span><span style="color: #808030;">></span> <span style="color: #800080;">{</span>\n        res<span style="color: #808030;">.</span>status<span style="color: #808030;">(</span><span style="color: #008c00;">400</span><span style="color: #808030;">)</span><span style="color: #808030;">.</span>send<span style="color: #808030;">(</span><span style="color: #800000;">"</span><span style="color: #0000e6;">Unable to save data</span><span style="color: #800000;">"</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n      <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n    <span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n<span style="color: #800080;">}</span><span style="color: #808030;">)</span><span style="color: #800080;">;</span>\n</pre>\n<h2>And that’s it!</h2>\n<p>You have now successfully added authentication to your Node Express setup. Next up is creating a full frontend system with a login and dashboard page for our blog</p>\n<p><img src="https://media.giphy.com/media/bWS1Vh9mVkcZq/giphy.gif" alt=""></p>\n'}],error:null,state:{bloglist:[{title:"Using Sentiment Analysis to test user interaction",published:s,description:"Using AWS Comprehend to perform Sentiment Analysis on comments.",tags:"javascript,AWS, AWS Comprehend, Machine Learning",thumbnail:n,header:n,ctime:"2019-05-20",slug:"5ce1f1631c9d440000cbc59c"},{title:"My weekend with AWS DeepRacer",published:s,description:"Here are the results of my weekend playing around with AWS DeepRacer",tags:"javascript,AWS, AWS DeepRacer, Machine Learning",thumbnail:e,header:e,ctime:t,slug:"5ce13a901c9d4400004275bd"},{title:"Adding Service Worker to my site",published:s,description:"Whoops! I forgot to add Service Worker to my site. Probably about time to do that...",tags:"javascript,service worker",thumbnail:r,header:r,ctime:t,slug:"5ce1adde1c9d4400007337c6"},{title:l,published:s,description:p,tags:a,thumbnail:o,header:o,ctime:"2019-04-19",slug:"5c7c00ffa1e5fbe51cd94951"},{title:"How I built a blog with Node, Express and Mongo",published:s,description:"Let's get blogging!",tags:"javascript,Express,Node,Mongo",thumbnail:c,header:c,ctime:"2019-04-02",slug:"5c7be6e2a1e5fbe51cd94950"},{title:"Let's begin again...",published:s,description:"Nicholas Griffin V.Something",tags:"Meta",thumbnail:y,header:y,ctime:"2019-04-01",slug:"5c7af91ae6bdacc5ee62ecfe"}]},serverRendered:s}}(!0,"https://nicholasgriffin.dev/uploads/bp/2019/March/users_js.jpg","https://cdn.nicholasgriffin.dev/images/Screenshot+2019-05-20+at+01.08.17.png","javascript,Node, Express, Passport.js,authentication","Adding authentication to our Express blog with Passport.js","Time to make things secure","https://cdn.nicholasgriffin.dev/images/Screenshot+2019-05-19+at+12.19.03.png","2019-05-19","https://cdn.nicholasgriffin.dev/images/Screenshot+2019-05-19+at+20.24.38.png","https://nicholasgriffin.dev/uploads/bp/2019/March/postman_addpost_2019.jpg","https://i.ibb.co/g6MPvkg/Screenshot-2019-03-02-at-21-45-38.jpg")</script><script src="/_nuxt/335238b4871730cf9f7d.js" defer></script><script src="/_nuxt/ad3882a62a81c04ccdbd.js" defer></script><script src="/_nuxt/d26db56abffc2e10e685.js" defer></script><script src="/_nuxt/ed5ca3c40fa941f82244.js" defer></script><script src="/_nuxt/8c50d3902d6da8d5999e.js" defer></script>
  </body>
</html>
